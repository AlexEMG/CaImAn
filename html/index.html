<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Caiman: CaImAn</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Caiman_logo_FIsmall.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Caiman
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">A Computational toolbox for large scale Calcium Imaging Analysis</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="namespace_ca_im_an.html" title="compare how the elements behave ">CaImAn</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="image">
<img src="https://github.com/simonsfoundation/CaImAn/blob/master/docs/LOGOS/Caiman_logo_FI.png" width="500" align="right"/>
</div>
<p><a href="https://gitter.im/agiovann/SOURCE_EXTRACTION_PYTHON?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"></a></p>
<p><a href="https://travis-ci.org/simonsfoundation/CaImAn"></a></p>
<p>A Computational toolbox for large scale **Ca**lcium **Im**aging **An**alysis*</p>
<p>Recent advances in calcium imaging acquisition techniques are creating datasets of the order of Terabytes/week. Memory and computationally efficient algorithms are required to analyze in reasonable amount of time terabytes of data. This projects implements a set of essential methods required in the calcium imaging movies analysis pipeline. Fast and scalable algorithms are implemented for motion correction, movie manipulation and source and spike extraction.</p>
<h3>Features</h3>
<ul>
<li>Handling of very large datasets<ul>
<li>Memory mapping</li>
<li>Frame-by-frame online processing (some functions)</li>
<li>opencv-based efficient movie playing and resizing</li>
</ul>
</li>
<li>Motion correction<ul>
<li>Fast parallelizable open-cv and fft-based motion correction of large movies</li>
<li>Run also in online mode (i.e. one frame at a time)</li>
<li>non rigid motion correction</li>
</ul>
</li>
<li>Source extraction<ul>
<li>identification of pixles associated to each neuron/neuronal structure</li>
<li>deals with heavily overlaping and neuroopil contaminated movies</li>
<li>separates different sources based on Nonnegative Matrix Factorization algorithms</li>
</ul>
</li>
<li>Denoising, deconvolution and spike extraction<ul>
<li>spikes can be inferred from fluorescence traces</li>
<li>also works in online mode (i.e. one sample at a time)</li>
</ul>
</li>
</ul>
<h3>Installation</h3>
<ul>
<li>Installation on Mac<ul>
<li>Download and install Anaconda (Python 2.7 or Python 3.5) <a href="http://docs.continuum.io/anaconda/install">http://docs.continuum.io/anaconda/install</a></li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line">git clone https://github.com/simonsfoundation/CaImAn</div><div class="line">cd CaImAn/</div><div class="line">git pull</div><div class="line"></div><div class="line">EITHER</div><div class="line">conda create -n CaImAn python=3.5 --file requirements_conda.txt   (For Python 3)</div><div class="line">OR</div><div class="line">conda create -n CaImAn ipython --file requirements_conda.txt   (For Python 2) </div><div class="line"></div><div class="line">source activate CaImAn</div><div class="line">pip install -r requirements_pip.txt</div><div class="line">conda install -c menpo opencv3=3.1.0</div><div class="line">python setup.py build_ext -i</div><div class="line">conda install bokeh</div></div><!-- fragment --><ul>
<li>Installation on Linux<ul>
<li>Download and install Anaconda (Python 2.7 or Python 3.5) <a href="http://docs.continuum.io/anaconda/install">http://docs.continuum.io/anaconda/install</a></li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line">git clone https://github.com/simonsfoundation/CaImAn</div><div class="line">cd CaImAn/</div><div class="line">git pull</div><div class="line">conda create -n CaImAn ipython --file requirements_conda.txt    </div><div class="line">source activate CaImAn</div><div class="line">pip install -r requirements_pip.txt</div><div class="line">conda install -c menpo opencv3=3.2.0</div><div class="line">python setup.py build_ext -i</div><div class="line">conda install bokeh</div></div><!-- fragment --><ul>
<li>To make the package available from everywhere and have it working <em>efficiently</em> under any configuration ALWAYS run these lines before starting spyder:</li>
</ul>
<div class="fragment"><div class="line">export PYTHONPATH=&quot;/path/to/caiman:$PYTHONPATH&quot;</div><div class="line">export MKL_NUM_THREADS=1</div><div class="line">export OPENBLAS_NUM_THREADS=1</div></div><!-- fragment --><ul>
<li>Installation on posix (Windows)<ul>
<li><p class="startli">Download and install Anaconda (Python 2.7) <a href="http://docs.continuum.io/anaconda/install">http://docs.continuum.io/anaconda/install</a>, GIT (<a href="https://git-scm.com/">https://git-scm.com/</a>) and Microsoft Visual C++ Compiler for Python 2.7 <a href="https://www.microsoft.com/en-us/download/details.aspx?id=44266">https://www.microsoft.com/en-us/download/details.aspx?id=44266</a></p>
<p class="startli">```bash</p>
<p class="startli">git clone <a href="https://github.com/simonsfoundation/CaImAn">https://github.com/simonsfoundation/CaImAn</a> cd <a class="el" href="namespace_ca_im_an.html" title="compare how the elements behave ">CaImAn</a> git pull conda update conda conda create -n <a class="el" href="namespace_ca_im_an.html" title="compare how the elements behave ">CaImAn</a> ipython &ndash;file requirements_conda.txt activate <a class="el" href="namespace_ca_im_an.html" title="compare how the elements behave ">CaImAn</a> pip install -r requirements_pip.txt conda install -c menpo opencv3=3.1.0 python <a class="el" href="setup_8py.html">setup.py</a> build_ext -i conda update &ndash;all</p>
<p class="startli">```</p>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md6"></a>
Example</h1>
<h3>Demos</h3>
<ul>
<li>Notebooks : The notebooks provide a simple and friendly way to get into <a class="el" href="namespace_ca_im_an.html" title="compare how the elements behave ">CaImAn</a> and understand its main characteristics.<ul>
<li>you can find them in directly in <a class="el" href="namespace_ca_im_an.html" title="compare how the elements behave ">CaImAn</a> and launch them from your ipython Notebook application:</li>
<li><p class="startli">to launch jupyter notebook :</p>
<p class="startli">```bash</p>
<p class="startli">source activate <a class="el" href="namespace_ca_im_an.html" title="compare how the elements behave ">CaImAn</a> conda launch jupyter</p>
<p class="startli">```</p>
</li>
</ul>
</li>
</ul>
<p>/!\ if you want to launch directly the python files, please be advised that your python console still needs to be in the <a class="el" href="namespace_ca_im_an.html" title="compare how the elements behave ">CaImAn</a> folder and not somewhere else.</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Testing</h1>
<ul>
<li>As of today, all of the commits needs to be previously tested before asking for a pull request. Call 'nosetests' program from inside of your <a class="el" href="namespace_ca_im_an.html" title="compare how the elements behave ">CaImAn</a> folder to look for defects.</li>
</ul>
<h3>general_test</h3>
<ul>
<li>This test will run the entire <a class="el" href="namespace_ca_im_an.html" title="compare how the elements behave ">CaImAn</a> program and look for differences against the original one. If your changes have made significant differences able to be recognise by this test. You are left with two choices :<ul>
<li>Either it is a desired on purpose changement of the code. You will then need to submit your pull request. Adding to it the generated folder in tests/comparison/tests that you will need to rename 'tosend'</li>
<li>Else it is an unplanned difference that has been found by the tests. In this situation, happy debugging.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md8"></a>
Contributors:</h1>
<ul>
<li>Giovannucci, Andrea. <b>Simons Foundation</b></li>
<li>Pnevmatikakis, Eftychios. <b>Simons Foundation</b></li>
<li>Friedrich, Johannes. <b>Columbia University and Janelia Farm</b></li>
<li>Cobos, Erick. <b>Baylor College of Medicine</b></li>
<li>Staneva, Valentina. <b>eScience Institute</b></li>
<li>Deverett, Ben. <b>Princeton University</b></li>
<li>Kalfon, Jérémie. <b>University of Kent</b> , <b>ECE paris</b></li>
</ul>
<p>Please refer to the following wiki <a href="https://github.com/simonsfoundation/CaImAn/wiki/Processing-large-datasets">page</a> or read in the testing section below.</p>
<h1><a class="anchor" id="autotoc_md9"></a>
Deconvolution and demixing of calcium imaging data</h1>
<p>The code implements simultaneous source extraction and spike inference from large scale calcium imaging movies. The code is suitable for the analysis of somatic imaging data. Implementation for the analysis of dendritic/axonal imaging data will be added in the near future. The following references provide the theoretical background and original code for the included methods.</p>
<p>Pnevmatikakis, E.A., Soudry, D., Gao, Y., Machado, T., Merel, J., ... &amp; Paninski, L. (2016). Simultaneous denoising, deconvolution, and demixing of calcium imaging data. Neuron 89(2):285-299, <a href="http://dx.doi.org/10.1016/j.neuron.2015.11.037">http://dx.doi.org/10.1016/j.neuron.2015.11.037</a>. <a href="https://github.com/epnev/ca_source_extraction">Github repo</a>.</p>
<p>Pnevmatikakis, E.A., Gao, Y., Soudry, D., Pfau, D., Lacefield, C., ... &amp; Paninski, L. (2014). A structured matrix factorization framework for large scale calcium imaging data analysis. arXiv preprint arXiv:1409.2903. <a href="http://arxiv.org/abs/1409.2903">http://arxiv.org/abs/1409.2903</a>.</p>
<p>Friedrich J. and Paninski L. Fast active set methods for online spike inference from calcium imaging. NIPS, 29:1984-1992, 2016. <a href="https://papers.nips.cc/paper/6505-fast-active-set-methods-for-online-spike-inference-from-calcium-imaging">PDF</a>. <a href="https://github.com/j-friedrich/OASIS">Github repository</a>.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Code description and related packages</h1>
<p>The implementation of this package is developed in parallel with a MATLAB toobox, which can be found <a href="https://github.com/epnev/ca_source_extraction">here</a>.</p>
<p>Some tools that are currently available in Matlab and not in Python are at the following links</p>
<ul>
<li><a href="https://github.com/epnev/continuous_time_ca_sampler">MCMC spike inference</a></li>
<li><a href="https://github.com/danielso/ROI_detect">Group LASSO initialization and spatial CNMF</a></li>
</ul>
<h2>Troubleshooting </h2>
<p><b>Python 3 and spyder</b> if spyder crashes on mac os run </p><div class="fragment"><div class="line">brew install --upgrade openssl</div><div class="line">brew unlink openssl &amp;&amp; brew link openssl --force</div></div><!-- fragment --><p><b>SCS</b>:</p>
<p>if you get errors compiling scs when installing cvxpy you probably need to create a link to openblas or libgfortran in /usr/local/lib/, for instance:</p>
<p><code>sudo ln -s /Library/Frameworks/R.framework/Libraries/libgfortran.3.dylib /usr/local/lib/libgfortran.2.dylib</code></p>
<p><b>debian fortran compiler problems:</b> if you get the error gcc: error trying to exec 'cc1plus': execvp: No such file or directory in ubuntu run or issues related to SCS type</p>
<div class="fragment"><div class="line">sudo apt-get install g++ libatlas-base-dev gfortran  libopenblas-dev</div><div class="line">conda install openblas atlas</div></div><!-- fragment --><p>if still there are issues try</p>
<p><code>export LD_LIBRARY_PATH=/path_to_your_home/anaconda2/lib/</code></p>
<p>if more problems try</p>
<div class="fragment"><div class="line">conda install  atlas (only Ubuntu)</div><div class="line">pip install &#39;tifffile&gt;=0.7&#39;</div><div class="line">conda install accelerate</div><div class="line">conda install openblas </div></div><!-- fragment --><p><b>CVXOPT</b>:</p>
<p>If you are on Windows and don't manage to install or compile cvxopt, a simple solution is to download the right binary <a href="http://www.lfd.uci.edu/~gohlke/pythonlibs/#cvxopt">there</a> and install the library by typing:</p>
<div class="fragment"><div class="line">pip install cvxopt-1.1.7-XXXX.whl</div></div><!-- fragment --><h2>Test the system </h2>
<p><b>SINGLE PATCH</b></p>
<p>In case you used installation af point 1 above you will need to download the test files from <a href="https://github.com/agiovann/Constrained_NMF/releases/download/v0.3/Demo.zip">https://github.com/agiovann/Constrained_NMF/releases/download/v0.3/Demo.zip</a></p>
<p>A. Go into the cloned folder, type <code>python demo.py</code></p>
<p>B. Using the Spyder (type <code>conda install spyder</code>) IDE. </p><pre class="fragment">1. Unzip the file Demo.zip (you do not need this step if you installed dusing method 2 above, just enter the Constrained_NMF folder and you will find all the required files there).
2. Open the file demo.py with spyder
3. change the base_folder variable to point to the folder you just unzipped
3. Run the cells one by one inspecting the output
4. Remember to stop the cluster (last three lines of file). You can also stop it manually by typing in a terminal
'ipcluster stop'
</pre><p>C. Using notebook. </p><pre class="fragment">1. Unzip the file Demo.zip (you do not need this step if you installed dusing method 3 above, just enter the Constrained_NMF folder and you will find all the required files there).
2. type `ipython notebook`
3. open the notebook called demoCNMF.ipynb 
4. change the base_folder variable to point to the folder you just unzipped
5. and run cell by cell inspecting the result
6. Remember to stop the cluster (last three lines of file). You can also stop it manually by typing in a terminal
'ipcluster stop'
</pre><p><b>MULTI PATCH</b></p><ul>
<li>Download the two demo movies <a href="https://github.com/agiovann/Constrained_NMF/releases/download/v0.4-alpha/Patch_demo.zip">here</a> (courtesy of Dr. Sue Ann Koay from the Tank Lab, Princeton Neuroscience Institute, Princeton. NJ). Unzip the folder. Then in Spyder open the file demo_patches.py, and change the base_folder variable to point to the folder you just unzipped.</li>
<li>Run one by one the cells (delimited by '#%')</li>
<li>Inspect the results. The demo will start a cluster and process pathes of the movie (more details <a href="https://github.com/agiovann/Constrained_NMF/wiki/Processing-large-datasets">here</a>) in parallel (cse.map_reduce.run_CNMF_patches). Afterwards, it will merge the results back together and proceed to firstly merge potentially overlaping components (cse.merge_components) from different patches, secondly to update the spatial extent of the joined spatial components (cse.spatial.update_spatial_components), and finally denoising the traces (cse.temporal.update_temporal_components). THe final bit is used for visualization.</li>
</ul>
<h1><a class="anchor" id="autotoc_md11"></a>
Documentation</h1>
<p>Documentation of the code can be found <a href="http://agiovann.github.io/Constrained_NMF">here</a></p>
<h1><a class="anchor" id="autotoc_md12"></a>
Dependencies</h1>
<p>The code uses the following libraries</p><ul>
<li><a href="http://www.numpy.org/">NumPy</a></li>
<li><a href="http://www.scipy.org/">SciPy</a></li>
<li><a href="http://matplotlib.org/">Matplotlib</a></li>
<li><a href="http://scikit-learn.org/stable/">Scikit-Learn</a></li>
<li><a href="https://pypi.python.org/pypi/tifffile">Tifffile</a> For reading tiff files. Other choices can work there too.</li>
<li><a href="http://www.cvxpy.org/">cvxpy</a> for solving optimization problems</li>
<li><a href="http://ipyparallel.readthedocs.org/en/latest/">ipyparallel</a> for parallel processing</li>
<li><a href="http://opencv.org/">opencv</a> for efficient image manipulation and visualization</li>
</ul>
<h1><a class="anchor" id="autotoc_md13"></a>
External Dependencies</h1>
<p>For the constrained deconvolution method (<code>deconvolution.constrained_foopsi</code>) various solvers can be used, each of which requires some additional packages:</p>
<ol type="1">
<li><code>'cvxpy'</code>: (default) For this option, the following packages are needed:<ul>
<li><a href="http://cvxopt.org/">CVXOPT</a> Required.</li>
<li><a href="http://www.cvxpy.org/">CVXPY</a> Required.</li>
</ul>
</li>
<li><code>'cvx'</code>: For this option, the following packages are needed:<ul>
<li><a href="http://cvxopt.org/">CVXOPT</a> Required.</li>
<li><a href="http://picos.zib.de/">PICOS</a> Required.</li>
</ul>
</li>
</ol>
<p>In general <code>'cvxpy'</code> can be faster, when using the 'ECOS' or 'SCS' sovlers, which are included with the CVXPY installation.</p>
<h1><a class="anchor" id="autotoc_md14"></a>
Questions, comments, issues</h1>
<p>Please use the gitter chat room (use the button above) for questions and comments and create an issue for any bugs you might encounter.</p>
<h1><a class="anchor" id="autotoc_md15"></a>
License</h1>
<p>This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License along with this program. If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>. ``` </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div class="footer" role="contentinfo">
&copy; Copyright 2015, Eftychios Pnevmatikakis and Andrea Giovannucci.Created using 
<a href="http://www.stack.nl/~dimitri/doxygen/">Doxygen</a> </div>